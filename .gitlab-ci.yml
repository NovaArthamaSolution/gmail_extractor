image:
  name: asia.gcr.io/bi-gojek/gmail2bq-base

stages:
  - testing
  - deploy
  - scheduled

variables:
  PATH_CREDENTIAL: "/tmp/gmail2bq.id_rsa"
  ANSIBLE_HOST_KEY_CHECKING: "false"
  IMAGE_NAME: gmail2bq
  IMAGE_URL_TAGLESS: artifactory-gojek.golabs.io:6555/entbi-${IMAGE_NAME}
  IMAGE_URL: $IMAGE_URL_TAGLESS:latest
  IMAGE_URL_WITH_TAG: $IMAGE_URL_TAGLESS:${CI_COMMIT_TAG:1}
  tmp_dir: tmp
  export_dir: data/in

# before_script:
#   - mkdir -p $export_dir $tmp_dir
#   - cp $GOOGLE_APPLICATION_CREDENTIALS $tmp_dir/
#   - cp $GMAIL_CREDENTIAL_FILE $tmp_dir/credentials.json

testing:config:
  image: "python:3.8"
  stage: testing
  except:
    - schedules
  script:
    - pip install -qr requirements.txt
    - python tests/config_validation.py tests/config_schema.yaml configs/


testing:unit:
  stage: testing
  except:
    - schedules
  tags:
    - docker
    - docker_artifactory
  variables:
    env : TEST_CONFIG 
  script:
    - echo $IMAGE_URL_TAGLESS $IMAGE_URL
    - DSTART=`date +"%Y-%m-%d" -d "-1 day" `
    - DEND=`date +"%Y-%m-%d" -d "$DSTART + 1 day" ` 
    - echo "BQ_SERVICE_ACCOUNT=$BQ_SERVICE_ACCOUNT" >> .app.conf	
    - docker build  --no-cache  -t $IMAGE_URL_TAGLESS:tests -f $( pwd )/tests/Dockerfile . 
    - docker run --env-file .app.conf -v `pwd`/${CONFIG_DIRPATH}:/$export_dir --mount type=bind,source=$GMAIL_TOKEN_FILE,target=/data/in/token.json -e env='TEST_CONFIG' $IMAGE_URL_TAGLESS:tests /$export_dir/config.yaml -s $DSTART -e $DEND

build:docker:  
  image: docker:latest
  stage: deploy
  services:
    - docker:18.09.7-dind
  # variables:
  #   DOCKER_HOST: tcp://docker:2375/
  #   DOCKER_DRIVER: overlay2
  tags:
    - docker
    - docker_artifactory
    # - dind
  variables:
    tmp_dir: tmp
    export_dir: data/in
  script:
    - docker build  --no-cache -t ${IMAGE_URL} -f $( pwd )/Dockerfile . 
    - docker push ${IMAGE_URL}
  only:
    - master
  except:
    - schedules

build:tagged:  
  image: docker:latest
  stage: deploy
  services:
    - docker:18.09.7-dind
  # variables:
  #   DOCKER_HOST: tcp://docker:2375/
  #   DOCKER_DRIVER: overlay2
  tags:
    - docker
    - docker_artifactory
    # - dind
  variables:
    tmp_dir: tmp
    export_dir: data/in
  script:
    - docker build  --no-cache -t $IMAGE_URL_WITH_TAG -f $( pwd )/Dockerfile . 
    - docker push $IMAGE_URL_WITH_TAG
    - docker tag  $IMAGE_URL_WITH_TAG $IMAGE_URL_TAGLESS:latest
    - docker push $IMAGE_URL_TAGLESS:latest
  only:
    variables:
      - $CI_COMMIT_TAG =~ /^v.*$/
  except:
    - schedules

run_schedules:
  only:
    - schedules
  tags:
    - docker
    - docker_artifactory
  stage: scheduled
  variables:
    GOOGLE_APPLICATION_CREDENTIALS: /root/gcloud-credential.json
  before_script:
    - DSTART=`date +"%Y-%m-%d" -d "$delta_day day" ` 
    - DEND=`date +"%Y-%m-%d" -d "$DSTART + 1 day" ` 
    - echo "BQ_SERVICE_ACCOUNT=$BQ_SERVICE_ACCOUNT" >> .app.conf	
    - echo "env=TEST_CONFIG" >> .app.conf
  script:
   - docker run --env-file .app.conf -v `pwd`/${CONFIG_DIRPATH}:/$export_dir --mount type=bind,source=$GMAIL_TOKEN_FILE,target=/data/in/token.json --mount type=bind,source=$GOOGLE_APPLICATION_CREDENTIALS,target=/tmp/GOOGLE_APPLICATION_CREDENTIALS  $IMAGE_URL_TAGLESS:latest /$export_dir/config.yaml -s $DSTART
